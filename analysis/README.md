# 体操動作の3D解析

本分析コードは、融合された3D関键点データから以下の3つの指標を計算します。

## 分析指標

### 1. ねじれ（Twist）
**定義**: 両肩と両股関節の回旋角度の差

- 両肩を結ぶ線と両股関節を結ぶ線の水平面での回旋角度の差を計算
- 正の値：上半身が下半身に対して逆時計回りに回旋
- 負の値：上半身が下半身に対して時計回りに回旋
- 単位：度（°）

**意義**: 体幹のねじれ具合を定量的に評価。大きなねじれは、動作の流動性と制御能力を示す。

### 2. 姿勢（Posture / Trunk Tilt）
**定義**: 両肩と両股関節の各中点を結んだ線の鉛直軸に対する角度

- 股関節中点から肩中点への体幹ベクトルと鉛直軸のなす角度
- 正の値：前傾（体が前に傾いている）
- 負の値：後傾（体が後ろに傾いている）
- 0度：完全に垂直
- 単位：度（°）

**意義**: 体の傾き具合を評価。動作の安定性とバランスの指標。

### 3. 脱力（Relaxation / Wrist Lead Angle）
**定義**: 体幹が正面を向いた時点での遅れてくる手の手首の回旋角度（先行角度）

計算手順：
1. 回旋方向を検出（逆時計回り/時計回り）
2. 回旋方向の対側の手を「遅れてくる手」として選択
   - 逆時計回り → 右手が遅れる
   - 時計回り → 左手が遅れる
3. 体幹が正面を向いた時刻を検出
4. その時点での手首の体幹に対する角度を計算

**意義**: 
- 脱力が十分な場合、遅れてくる手は体幹より遅れて回旋する
- 正面時の手首の先行角度が大きい = より良い脱力
- 単位：度（°）

## 使用方法

### 実行

```bash
cd /workspace/code
python analysis/main.py
```

### 出力

各人物について以下のファイルが生成されます：

- `logs/analysis/person_{id}/analysis_{id}.json` - 数値データ
- `logs/analysis/person_{id}/analysis_{id}.png` - 可視化グラフ

### JSONフォーマット

```json
{
  "person_id": "1",
  "fps": 60.0,
  "n_frames": 300,
  "twist_deg": [...],  // 各フレームのねじれ角度
  "tilt_deg": [...],   // 各フレームの傾き角度
  "lead_angle_deg": [...],  // 各フレームの手首先行角度
  "frontal_mask": [...],  // 正面を向いているフレーム
  "lagging_hand": "right",  // 遅れてくる手
  "statistics": {
    "twist": {
      "mean": 15.3,
      "std": 8.2,
      "min": -5.1,
      "max": 35.7
    },
    "tilt": {...},
    "lead_angle": {...}
  }
}
```

## 座標系

- **世界座標系**を使用
  - X軸: 左から右（横方向）
  - Y軸: 下から上（鉛直方向）
  - Z軸: 後ろから前（前後方向）

## 関键点インデックス（MHR70）

```python
IDX = {
    "lhip": 9,      # 左股関節
    "rhip": 10,     # 右股関節
    "lsho": 5,      # 左肩
    "rsho": 6,      # 右肩
    "lwrist": 40,   # 左手首
    "rwrist": 41,   # 右手首
}
```

## 技術的詳細

### 角度計算方法

1. **水平面投影**: Y成分を0にして水平面に投影
2. **正規化**: ベクトルを単位ベクトルに正規化
3. **角度計算**: arccos(内積)で角度を計算
4. **方向判定**: 外積で回転方向を判定

### フィルタリング

- 正面判定の閾値: ±0.1ラジアン（約5.7度）
- この範囲内の股関節角度を「正面」と判定

## 依存関係

- numpy
- matplotlib
- fuse.load モジュール（融合3D関键点のロード）

## 参考

このコードは体操の回旋動作（ひねり技）の定量的解析を目的としています。
