# 体操動作の3D解析

本分析コードは、融合された3Dキーポイントデータから以下の3つの指標を計算します。

## 分析指標

### 1. ねじれ（Twist）
**定義**: 両肩と両股関節の回旋角度の差

- 両肩を結ぶ線と両股関節を結ぶ線の水平面での回旋角度の差を計算
- 正の値：上半身が下半身に対して逆時計回りに回旋
- 負の値：上半身が下半身に対して時計回りに回旋
- 単位：度（°）

**意義**: 体幹のねじれ具合を定量的に評価。大きなねじれは、動作の流動性と制御能力を示す。

### 2. 姿勢（Posture / Trunk Tilt）
**定義**: 両肩と両股関節の各中点を結んだ線の鉛直軸に対する角度

- 股関節中点から肩中点への体幹ベクトルと鉛直軸のなす角度
- 正の値：前傾（体が前に傾いている）
- 負の値：後傾（体が後ろに傾いている）
- 0度：完全に垂直
- 単位：度（°）

**意義**: 体の傾き具合を評価。動作の安定性とバランスの指標。

### 3. 脱力（Relaxation / Wrist Lead Angle）
**定義**: 体幹が正面を向いた時点での遅れてくる手の手首の回旋角度（先行角度）

計算手順：
1. 回旋方向を検出（逆時計回り/時計回り）
2. 回旋方向の対側の手を「遅れてくる手」として選択
   - 逆時計回り → 右手が遅れる
   - 時計回り → 左手が遅れる
3. 体幹が正面を向いた時刻を検出
4. その時点での手首の体幹に対する角度を計算

**意義**: 
- 脱力が十分な場合、遅れてくる手は体幹より遅れて回旋する
- 正面時の手首の先行角度が大きい = より良い脱力
- 単位：度（°）

## 使用方法

### 実行

```bash
cd /workspace/code
python analysis/main.py
```

### 出力

各人物について以下のファイルが生成されます：

- `logs/analysis/person_{id}/analysis_{id}.json` - 数値データ
- `logs/analysis/person_{id}/analysis_{id}.png` - 可視化グラフ

### JSONフォーマット

```json
{
  "person_id": "1",
  "fps": 60.0,
  "n_frames": 300,
  "twist_deg": [...],  // 各フレームのねじれ角度
  "tilt_deg": [...],   // 各フレームの傾き角度
  "lead_angle_deg": [...],  // 各フレームの手首先行角度
  "frontal_mask": [...],  // 正面を向いているフレーム
  "lagging_hand": "right",  // 遅れてくる手
  "statistics": {
    "twist": {
      "mean": 15.3,
      "std": 8.2,
      "min": -5.1,
      "max": 35.7
    },
    "tilt": {...},
    "lead_angle": {...}
  }
}
```

## ログファイル例: person_1 の解析結果

対象ファイル: [logs/analysis/person_1/analysis_1.json](logs/analysis/person_1/analysis_1.json)

### 各フィールドの意味

- `person_id`: 被写体ID。
- `fps`: 入力動画のフレームレート。
- `n_frames`: 解析対象のフレーム数。
- `twist_deg`: 各フレームのねじれ角度列（度）。長さは `n_frames`。
- `tilt_deg`: 各フレームの体幹傾き角度列（度）。長さは `n_frames`。
- `lead_angle_deg`: 各フレームの手首先行角度列（度）。長さは `n_frames`。
- `frontal_mask`: 正面判定フラグ列。`true` のフレームが「正面」判定。
- `lagging_hand`: 回旋方向に対して遅れてくる手（`left` / `right`）。
- `statistics`: 指標の要約統計。
  - `twist`: ねじれ角の平均・標準偏差・最小・最大。
  - `tilt`: 体幹傾き角の平均・標準偏差・最小・最大。
  - `lead_angle`: 手首先行角の平均・標準偏差・正面フレームのみの平均。

### このファイルの簡易分析

- `n_frames` は 1229 で、`twist_deg` / `tilt_deg` / `lead_angle_deg` の各配列長と一致。
- `twist` の平均は約 -2.83 度で全体としてはほぼ中立、標準偏差が約 44.69 度と大きく回旋の振れ幅が大きい。
- `twist` の最小・最大が約 -359 度〜 359 度となっており、角度のラップ（-180〜180 を跨ぐ連続回転）が含まれている可能性が高い。
- `tilt` の平均は約 -86.16 度で、定義上は後傾が強い状態が長く続いていることを示す。
- `lead_angle` の `frontal_mean` が `null` のため、正面判定フレームが存在しない（`frontal_mask` が全て `false`）可能性がある。

### 可視化画像の分析（person_1）

対象ファイル:

- [logs/analysis/person_1/analysis_1_timeseries.png](logs/analysis/person_1/analysis_1_timeseries.png)
- [logs/analysis/person_1/analysis_1_distributions.png](logs/analysis/person_1/analysis_1_distributions.png)
- [logs/analysis/person_1/analysis_1_correlation.png](logs/analysis/person_1/analysis_1_correlation.png)
- [logs/analysis/person_1/analysis_1_cdf.png](logs/analysis/person_1/analysis_1_cdf.png)

#### 1. 時系列グラフ（analysis_1_timeseries.png）

**目的**: 3つの指標（twist, tilt, lead_angle）の時間変化を可視化し、動作の動的特性を把握する。

**方法**:
- X軸: 時間（秒）、Y軸: 角度（度）
- 3つのサブプロットで各指標を独立に表示
- 動作の周期性、スパイク、トレンドを視覚的に確認

**person_1 の観察結果**:
- `twist` は周期的な上下動が見られる一方、複数の時刻で -300 度付近まで急落し、1 回だけ +300 度付近のスパイクがある。角度ラップ（連続回転の跨ぎ）が時系列で顕在化している。
- `tilt` は -88 〜 -85 度付近で小さく揺れ、全体として安定している。
- `lead_angle` はおおよそ周期的な波形で、最大は +60 度付近、最小は -150 度付近まで振れる。

---

#### 2. 分布・箱ひげ図（analysis_1_distributions.png）

**目的**: 各指標の統計的分布特性を可視化し、中央傾向・散らばり・外れ値を把握する。

**方法**:
- 左列: ヒストグラム（度数分布）
  - ビン数を適切に設定し、角度の出現頻度を表示
  - 平均値（赤破線）と ±1σ 範囲（黄破線）を重ね表示
- 右列: 箱ひげ図（box plot）
  - 中央値（オレンジ線）、IQR（箱の範囲）、ひげ（1.5×IQR）、外れ値（○印）を表示
  - 平均・標準偏差・範囲を注釈で明記

**person_1 の観察結果**:
- `twist` のヒストグラムは 0 度付近に集中しつつ、外れ値として ±300 度超の点がある。箱ひげの範囲表示は約 -359.1 〜 359.6 度。
- `tilt` は平均 -86.2 度、標準偏差 1.6 度で非常に狭い分布。箱ひげの範囲は約 -89.4 〜 -76.9 度。
- `lead_angle` は平均 -29.5 度、標準偏差 61.6 度で広い分布。箱ひげの範囲は約 -150.6 〜 82.5 度。

---

#### 3. 相関散布図（analysis_1_correlation.png）

**目的**: 3指標間の線形相関関係を可視化し、動作の協調パターンを把握する。

**方法**:
- 3つのサブプロットで各ペアの散布図を表示
  - `twist` vs `tilt`（青）
  - `twist` vs `lead_angle`（緑）
  - `tilt` vs `lead_angle`（橙）
- Pearson 相関係数 (r) をタイトルに表示
- 各点が1フレームに対応し、分布の形状から関係性を評価

**person_1 の観察結果**:
- `twist` と `tilt` は弱い正の相関（r = 0.195）。
- `twist` と `lead_angle` は中程度の負の相関（r = -0.402）。体幹のねじれが大きいとき手首の先行角度は小さくなる傾向。
- `tilt` と `lead_angle` は弱〜中程度の負の相関（r = -0.317）。
- 散布図上では `twist` に角度ラップ由来の外れ点が見られる。

---

#### 4. 累積分布関数（CDF, analysis_1_cdf.png）

**目的**: 各指標の累積確率分布を可視化し、中央値・四分位・パーセンタイルを直感的に把握する。

**方法**:
- X軸: 角度（度）、Y軸: 累積確率（0〜1）
- 3つのサブプロットで各指標の CDF を表示
- 平均値を赤破線で表示
- P25, P50（中央値）, P75 を黄破線で表示
- CDF の勾配が急な箇所 = その角度範囲に多くのフレームが集中

**person_1 の観察結果**:
- `twist` の CDF は 0 度付近で急峻に立ち上がり、中央値・四分位も小さい角度範囲に集まる。
- `tilt` の CDF は -86 度付近で急峻に立ち上がり、分布の狭さを示す。
- `lead_angle` の CDF は緩やかに上昇し、広い角度範囲に分布している。

## 座標系

- **世界座標系**を使用
  - X軸: 左から右（横方向）
  - Y軸: 下から上（鉛直方向）
  - Z軸: 後ろから前（前後方向）

## 関键点インデックス（MHR70）

```python
IDX = {
    "lhip": 9,      # 左股関節
    "rhip": 10,     # 右股関節
    "lsho": 5,      # 左肩
    "rsho": 6,      # 右肩
    "lwrist": 40,   # 左手首
    "rwrist": 41,   # 右手首
}
```

## 技術的詳細

### 角度計算方法

1. **水平面投影**: Y成分を0にして水平面に投影
2. **正規化**: ベクトルを単位ベクトルに正規化
3. **角度計算**: arccos(内積)で角度を計算
4. **方向判定**: 外積で回転方向を判定

### フィルタリング

- 正面判定の閾値: ±0.1ラジアン（約5.7度）
- この範囲内の股関節角度を「正面」と判定

## 依存関係

- numpy
- matplotlib
- fuse.load モジュール（融合3D関键点のロード）